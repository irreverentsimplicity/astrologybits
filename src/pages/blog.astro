---
import BaseLayout from '../layouts/BaseLayout.astro';
import { getAllPosts } from '../lib/wordpress';
import { makeLinksRelative, updateWordPressImageUrls, cleanInternalUrl } from '../lib/utils';

const posts = await getAllPosts();

// Sort posts by date (newest first)
const sortedPosts = posts.sort((a, b) => new Date(b.date) - new Date(a.date));

// Create a fake page object for SEO
const blogPage = {
  title: 'Blog - Astrology Bits',
  uri: '/blog/',
  seo: {
    title: 'Astrology Blog - Latest Insights & Love Compatibility',
    metaDesc: 'Discover the latest astrology insights, love compatibility guides, and astrological wisdom. Explore relationships, zodiac signs, and cosmic influences.',
    canonical: 'https://astrologybits.com/blog/',
  }
};

function formatDate(dateString) {
  return new Date(dateString).toLocaleDateString('en-US', {
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  });
}

function getExcerpt(content, length = 150) {
  if (!content) return '';
  const text = content.replace(/<[^>]*>/g, '');
  return text.length > length ? text.substring(0, length) + '...' : text;
}

function getFeaturedImage(post) {
  return updateWordPressImageUrls(post.featuredImage?.node?.sourceUrl) || null;
}

function getFeaturedImageAlt(post) {
  return post.featuredImage?.node?.altText || post.title || 'Blog post image';
}
---

<BaseLayout page={blogPage}>
  <div class="blog-header">
    <h1>Latest Astrology Blog Posts</h1>
    <p class="blog-subtitle">Discover cosmic insights, love compatibility guides, and astrological wisdom</p>
  </div>

  <div class="posts-grid">
    {sortedPosts.map(post => (
      <article class="post-card">
        {getFeaturedImage(post) && (
          <div class="post-image-container">
            <a href={cleanInternalUrl(post.uri)} class="post-image-link">
              <img 
                src={getFeaturedImage(post)} 
                alt={getFeaturedImageAlt(post)}
                class="post-image"
                loading="lazy"
              />
            </a>
          </div>
        )}
        <div class="post-card-content">
          <h2 class="post-card-title">
            <a href={cleanInternalUrl(post.uri)}>{post.title}</a>
          </h2>
          <time class="post-date" datetime={post.date}>
            {formatDate(post.date)}
          </time>
          <p class="post-excerpt">{getExcerpt(post.excerpt || post.content)}</p>
          <a href={cleanInternalUrl(post.uri)} class="read-more">Read More â†’</a>
        </div>
      </article>
    ))}
  </div>

  {sortedPosts.length === 0 && (
    <div class="no-posts">
      <p>No blog posts found. Check back soon for new content!</p>
    </div>
  )}

  <style>
    .blog-header {
      text-align: center;
      margin-bottom: 3rem;
      padding-bottom: 2rem;
      border-bottom: 1px solid #e1e5e9;
    }

    .blog-header h1 {
      font-size: 2.5rem;
      margin-bottom: 1rem;
      color: #2c3e50;
    }

    .blog-subtitle {
      font-size: 1.2rem;
      color: #5a6c7d;
      margin: 0;
      max-width: 600px;
      margin-left: auto;
      margin-right: auto;
    }

    .posts-grid {
      display: grid;
      gap: 2rem;
      margin-bottom: 3rem;
    }

    .post-card {
      background: #fff;
      border: 1px solid #e1e5e9;
      border-radius: 8px;
      overflow: hidden;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      position: relative;
      display: flex;
      flex-direction: column;
    }

    .post-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
    }

    .post-image-container {
      width: 100%;
      height: 200px;
      overflow: hidden;
      position: relative;
    }

    .post-image-link {
      display: block;
      width: 100%;
      height: 100%;
    }

    .post-image {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: transform 0.2s ease;
    }

    .post-card:hover .post-image {
      transform: scale(1.05);
    }

    .post-card-content {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      padding: 2rem;
      flex: 1;
    }

    .post-card-title {
      font-size: 1.5rem;
      margin: 0;
      line-height: 1.4;
    }

    .post-card-title a {
      color: #2c3e50 !important;
      text-decoration: none;
    }

    .post-card-title a:hover {
      color: #0066cc !important;
      text-decoration: underline;
    }

    .post-date {
      font-size: 0.9rem;
      color: #5a6c7d;
      font-weight: 500;
    }

    .post-excerpt {
      color: #4a5568;
      line-height: 1.6;
      margin: 0;
    }

    .read-more {
      color: #0066cc !important;
      font-weight: 500;
      text-decoration: none;
      align-self: flex-start;
      margin-top: auto;
    }

    .read-more:hover {
      text-decoration: underline;
    }

    .no-posts {
      text-align: center;
      padding: 4rem 2rem;
      color: #5a6c7d;
    }

    /* Responsive grid */
    @media (min-width: 768px) {
      .posts-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 640px) {
      .blog-header h1 {
        font-size: 2rem;
      }
      
      .blog-subtitle {
        font-size: 1rem;
      }
      
      .post-card {
        padding: 1.5rem;
      }
      
      .post-card-title {
        font-size: 1.3rem;
      }
    }
  </style>
</BaseLayout>